<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container animate-fade-in">
        <div class="header flex-between">
            <div class="flex">
                <img src="logo.jpg" alt="Logo" style="height: 50px;">
                <div>
                    <h1>Member Details</h1>
                    <p class="text-muted">View and manage member documents</p>
                </div>
            </div>
                <button class="btn" onclick="generatePDF()" title="Generate PDF Profile">ðŸ“„ PDF</button>
                <button class="btn" onclick="downloadAll()" title="Download All Documents">ðŸ“¥ Download All</button>
                <a href="#" id="edit-btn" class="btn btn-secondary">Edit</a>
                <a href="index.html" class="btn btn-secondary">Back</a>
            </div>
        </div>

        <div id="loading" class="text-center" style="padding: 4rem;">
            <p class="text-muted">Loading member data...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-light); padding-bottom: 1rem;">
                    Personal Information</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Member ID</span>
                        <span class="detail-value" id="d-customId"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value" id="d-name"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email Address</span>
                        <span class="detail-value" id="d-email"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Phone Number</span>
                        <span class="detail-value" id="d-phone"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Address</span>
                        <span class="detail-value" id="d-address"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">PAN Number</span>
                        <span class="detail-value" id="d-panNumber"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Citizenship No.</span>
                        <span class="detail-value" id="d-citizenshipNumber"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">National ID</span>
                        <span class="detail-value" id="d-nidNumber"></span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 3rem;">
                <h2 style="margin-bottom: 1.5rem;">Documents</h2>
                <div class="docs-grid">
                    <!-- Photo -->
                    <div class="doc-card" id="card-photo">
                        <div class="doc-header">
                            <span class="doc-title">Photo</span>
                        </div>
                        <div class="doc-preview" id="preview-photo">
                            <span>No Document</span>
                        </div>
                        <div class="actions">
                            <form class="upload-form" onsubmit="uploadDoc(event, 'photo')" style="width: 100%;">
                                <input type="file" required>
                                <button type="submit" class="btn btn-block" style="margin-top: 0.5rem;">Upload</button>
                            </form>
                        </div>
                    </div>

                    <!-- Citizenship Front -->
                    <div class="doc-card" id="card-citizenship_front">
                        <div class="doc-header">
                            <span class="doc-title">Citizenship (Front)</span>
                        </div>
                        <div class="doc-preview" id="preview-citizenship_front">
                            <span>No Document</span>
                        </div>
                        <div class="actions">
                            <form class="upload-form" onsubmit="uploadDoc(event, 'citizenship_front')"
                                style="width: 100%;">
                                <input type="file" required>
                                <button type="submit" class="btn btn-block" style="margin-top: 0.5rem;">Upload</button>
                            </form>
                        </div>
                    </div>

                    <!-- Citizenship Back -->
                    <div class="doc-card" id="card-citizenship_back">
                        <div class="doc-header">
                            <span class="doc-title">Citizenship (Back)</span>
                        </div>
                        <div class="doc-preview" id="preview-citizenship_back">
                            <span>No Document</span>
                        </div>
                        <div class="actions">
                            <form class="upload-form" onsubmit="uploadDoc(event, 'citizenship_back')"
                                style="width: 100%;">
                                <input type="file" required>
                                <button type="submit" class="btn btn-block" style="margin-top: 0.5rem;">Upload</button>
                            </form>
                        </div>
                    </div>

                    <!-- PAN -->
                    <div class="doc-card" id="card-pan">
                        <div class="doc-header">
                            <span class="doc-title">PAN Card</span>
                        </div>
                        <div class="doc-preview" id="preview-pan">
                            <span>No Document</span>
                        </div>
                        <div class="actions">
                            <form class="upload-form" onsubmit="uploadDoc(event, 'pan')" style="width: 100%;">
                                <input type="file" required>
                                <button type="submit" class="btn btn-block" style="margin-top: 0.5rem;">Upload</button>
                            </form>
                        </div>
                    </div>

                    <!-- NID -->
                    <div class="doc-card" id="card-nid">
                        <div class="doc-header">
                            <span class="doc-title">National ID</span>
                        </div>
                        <div class="doc-preview" id="preview-nid">
                            <span>No Document</span>
                        </div>
                        <div class="actions">
                            <form class="upload-form" onsubmit="uploadDoc(event, 'nid')" style="width: 100%;">
                                <input type="file" required>
                                <button type="submit" class="btn btn-block" style="margin-top: 0.5rem;">Upload</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');
        const token = localStorage.getItem('token');

        if (!token) window.location.href = 'index.html';
        if (!memberId) alert('No member specified');

        document.getElementById('edit-btn').href = `edit_member.html?id=${memberId}`;

        async function loadData() {
            try {
                const res = await fetch(`${API_URL}/members`, {
                    headers: { 'x-auth-token': token }
                });
                const members = await res.json();
                const member = members.find(m => m.id == memberId);

                if (!member) return alert('Member not found');

                document.getElementById('d-customId').textContent = member.customId || '-';
                document.getElementById('d-name').textContent = member.name || '-';
                document.getElementById('d-email').textContent = member.email || '-';
                document.getElementById('d-phone').textContent = member.phone || '-';
                document.getElementById('d-address').textContent = member.address || '-';
                document.getElementById('d-panNumber').textContent = member.panNumber || '-';
                document.getElementById('d-citizenshipNumber').textContent = member.citizenshipNumber || '-';
                document.getElementById('d-nidNumber').textContent = member.nidNumber || '-';

                // Load Documents
                const docRes = await fetch(`${API_URL}/members/${memberId}/documents`, {
                    headers: { 'x-auth-token': token }
                });
                const docs = await docRes.json();

                docs.forEach(doc => {
                    if (doc.docType && doc.docType !== 'other') {
                        const preview = document.getElementById(`preview-${doc.docType}`);
                        const card = document.getElementById(`card-${doc.docType}`);
                        if (preview) {
                            preview.innerHTML = `<img src="${doc.filePath}" alt="${doc.docType}">`;

                            // Add print button if not exists
                            if (!card.querySelector('.btn-print')) {
                                const actionsDiv = card.querySelector('.doc-header');

                                const btnContainer = document.createElement('div');
                                btnContainer.className = 'flex';
                                btnContainer.style.gap = '0.5rem';

                                const printBtn = document.createElement('button');
                                printBtn.className = 'btn btn-print';
                                printBtn.style.background = 'var(--success)';
                                printBtn.style.padding = '0.25rem 0.5rem';
                                printBtn.style.fontSize = '0.8rem';
                                printBtn.textContent = 'Print';
                                printBtn.onclick = () => printDoc(`${doc.filePath}`);

                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-danger';
                                deleteBtn.style.padding = '0.25rem 0.5rem';
                                deleteBtn.style.fontSize = '0.8rem';
                                deleteBtn.textContent = 'Delete';
                                deleteBtn.onclick = () => deleteDoc(doc.id);

                                btnContainer.appendChild(printBtn);
                                btnContainer.appendChild(deleteBtn);

                                actionsDiv.appendChild(btnContainer);
                            }

                            // Hide upload form
                            card.querySelector('.upload-form').style.display = 'none';
                        }
                    }
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (err) {
                console.error(err);
            }
        }

        async function uploadDoc(e, type) {
            e.preventDefault();
            const fileInput = e.target.querySelector('input[type="file"]');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('document', file);
            formData.append('docType', type);
            formData.append('title', type.toUpperCase());

            try {
                const res = await fetch(`${API_URL}/members/${memberId}/documents`, {
                    method: 'POST',
                    headers: { 'x-auth-token': token },
                    body: formData
                });
                if (res.ok) {
                    alert('Uploaded!');
                    location.reload();
                } else {
                    alert('Upload failed');
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function deleteDoc(docId) {
            if (!confirm('Are you sure you want to delete this document?')) return;

            try {
                const res = await fetch(`${API_URL}/members/documents/${docId}`, {
                    method: 'DELETE',
                    headers: { 'x-auth-token': token }
                });
                if (res.ok) {
                    alert('Document deleted');
                    location.reload();
                } else {
                    alert('Error deleting document');
                }
            } catch (err) {
                console.error(err);
            }
        }

        function printDoc(url) {
            const printWindow = window.open(url, '_blank');
            printWindow.onload = function () {
                printWindow.print();
            };
        }

        async function generatePDF() {
            try {
                const res = await fetch(`${API_URL}/members/${memberId}/pdf`, {
                    headers: { 'x-auth-token': token }
                });

                if (!res.ok) {
                    throw new Error('PDF generation failed');
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `member-profile-${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                console.error(err);
                alert('Error generating PDF');
            }
        }

        async function downloadAll() {
            try {
                const res = await fetch(`${API_URL}/members/${memberId}/download-all`, {
                    headers: { 'x-auth-token': token }
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.msg || 'Download failed');
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `member-documents-${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                console.error(err);
                alert(err.message || 'Error downloading documents');
            }
        }

        loadData();
    </script>
</body>

</html>